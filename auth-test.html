<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auth Test Isolation</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .result { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .loading { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>Authentication Hook Test</h1>
    <div id="results"></div>
    <div id="react-root"></div>
    
    <script type="module">
        const results = document.getElementById('results');
        
        function log(type, message) {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            results.appendChild(div);
            console.log(message);
        }
        
        try {
            // Import React and Query
            const React = await import('/@fs/home/runner/workspace/node_modules/.vite/deps/react.js?v=31cfa862');
            const ReactDOM = await import('/@fs/home/runner/workspace/node_modules/.vite/deps/react-dom_client.js?v=31cfa862');
            const Query = await import('/@fs/home/runner/workspace/node_modules/.vite/deps/@tanstack_react-query.js?v=31cfa862');
            
            log('success', 'React and TanStack Query imported successfully');
            
            // Create a simplified query client
            const queryClient = new Query.QueryClient({
                defaultOptions: {
                    queries: {
                        retry: false,
                        refetchInterval: false,
                        refetchOnWindowFocus: false,
                        staleTime: 0,
                        gcTime: 0,
                    }
                }
            });
            
            // Create an isolated auth test component
            function AuthTest() {
                const [authState, setAuthState] = React.useState('checking');
                const [queryStatus, setQueryStatus] = React.useState('initializing');
                
                // Test query directly
                const authQuery = Query.useQuery({
                    queryKey: ['/api/me'],
                    queryFn: async () => {
                        setQueryStatus('fetching');
                        log('loading', 'Starting auth fetch...');
                        
                        try {
                            const response = await fetch('/api/me', { credentials: 'include' });
                            log('loading', `Auth response: ${response.status}`);
                            
                            if (response.ok) {
                                const data = await response.json();
                                log('success', `Auth success: ${JSON.stringify(data)}`);
                                return data;
                            }
                            
                            if (response.status === 401 || response.status === 403) {
                                const data = { authenticated: false };
                                log('success', `Auth unauthenticated: ${JSON.stringify(data)}`);
                                return data;
                            }
                            
                            throw new Error(`${response.status}: ${response.statusText}`);
                        } catch (error) {
                            log('error', `Auth error: ${error.message}`);
                            return { authenticated: false };
                        }
                    }
                });
                
                React.useEffect(() => {
                    setQueryStatus(`isLoading: ${authQuery.isLoading}, error: ${!!authQuery.error}, data: ${!!authQuery.data}`);
                    
                    if (authQuery.data) {
                        setAuthState(authQuery.data.authenticated ? 'authenticated' : 'unauthenticated');
                        log('success', `Auth resolved: ${authQuery.data.authenticated ? 'authenticated' : 'unauthenticated'}`);
                    } else if (authQuery.error) {
                        setAuthState('error');
                        log('error', `Auth query error: ${authQuery.error.message}`);
                    } else if (authQuery.isLoading) {
                        setAuthState('loading');
                        log('loading', 'Auth still loading...');
                    }
                }, [authQuery.data, authQuery.isLoading, authQuery.error]);
                
                return React.createElement('div', { style: { background: '#f0f0f0', padding: '20px', margin: '10px 0' } }, [
                    React.createElement('h3', { key: 'title' }, 'Auth Component Status'),
                    React.createElement('p', { key: 'status' }, `Auth State: ${authState}`),
                    React.createElement('p', { key: 'query' }, `Query Status: ${queryStatus}`),
                    React.createElement('p', { key: 'loading' }, `Is Loading: ${authQuery.isLoading}`),
                    React.createElement('p', { key: 'data' }, `Has Data: ${!!authQuery.data}`),
                    React.createElement('p', { key: 'error' }, `Has Error: ${!!authQuery.error}`),
                ]);
            }
            
            // Render the test component
            const App = React.createElement(Query.QueryClientProvider, { client: queryClient },
                React.createElement(AuthTest)
            );
            
            const root = ReactDOM.createRoot(document.getElementById('react-root'));
            root.render(App);
            
            log('success', 'Auth test component rendered');
            
        } catch (error) {
            log('error', `Test failed: ${error.message}`);
            console.error('Full error:', error);
        }
    </script>
</body>
</html>